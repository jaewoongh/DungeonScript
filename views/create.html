<div class="navbar navbar-inverse navbar-fixed-top" role="navigation">
	<div class="container">
		<div class="navbar-header">
			<button type="button" class="navbar-toggle" data-toggle="collapse" data-target=".navbar-collapse">
				<span class="sr-only">Toggle navigation</span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
				<span class="icon-bar"></span>
			</button>
			<a class="navbar-brand" href="/">DungeonScript</a>
		</div>
		<div class="collapse navbar-collapse">
			<ul class="nav navbar-nav">
				<li><a href="#">Feature</a></li>
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown">Documentation <b class="caret"></b></a>
					<ul class="dropdown-menu">
						<li><a href="/documentation#basics">Basics</a></li>
						<li><a href="/documentation#grammar">Grammar</a></li>
					</ul>
				</li>
				<li class="active"><a href="/create">Create</a></li>
			</ul>
			<div class="navbar-form navbar-right">
				<button class="btn btn-default" onclick="goCompile()">PLAY <span class="glyphicon glyphicon-send"></span></button>
			</div>
			<ul class="nav navbar-nav navbar-right">
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown">Sample Codes <b class="caret"></b></a>
					<ul class="dropdown-menu">
						<li class="dropdown-header">Basics</li>
						<li><a id="sample-text">Text</a></li>
						<li><a id="sample-image">Image</a></li>
						<li><a id="sample-sound">Sound & Music</a></li>
						<li><a id="sample-keyinput">Key input</a></li>
						<li><a id="sample-dungeon">Dungeon</a></li>
						<li><a id="sample-minimap"><span class="glyphicon glyphicon-warning-sign"></span> Minimap</a></li>
						<li class="divider"></li>
						<li class="dropdown-header">Demo</li>
						<li><a><span class="glyphicon glyphicon-warning-sign"></span> Yet Another Dungeon</a></li>
					</ul>
				</li>
			</ul>
			<ul class="nav navbar-nav navbar-right">
				<li class="dropdown">
					<a href="#" class="dropdown-toggle" data-toggle="dropdown"><span class="glyphicon glyphicon-cog"></span> <b class="caret"></b></a>
					<ul class="dropdown-menu">
						<li id="savedtime" class="dropdown-header">Not saved</li>
						<li><a id="clear-editor">Clear editor</a></li>
						<li><a id="clear-save">Clear saved code</a></li>
					</ul>
				</li>
			</ul>
		</div>
	</div>
</div>

<div style="margin-top:50px">
	<div id="area-title" class="container" style="padding:0px; margin:0px 10px">
		<h3>Coding Page</h3>
		<p>Navigate sample codes on top-right menu to learn things.<br />
		Working codes are automatically saved for later visit.</p>
		<p><small>Note that you can drag bottom-right corner of the textbox to resize it freely.</small></p>
	</div>

	<form id="editor" action="/create" method="POST" target="_blank" onkeyup="setTimerForInterpreter()">
		<div id="area-ready" class="container" style="padding:0px; margin:10px">
			<h4>READY</h4>
			<p>Set/modify some meta data for the entire game.</p>
			<div class="col-md-8" style="padding:0px">
				<textarea id="txt-ready" name="ready" style="width:100%; max-width:100%; height:80px; font-family:Consolas,Andale Mono,Courier; font-size:small;" placeholder="title: 'Awesome Dungeon'" onblur="goInterprete()"></textarea>
			</div>
			<div id="console-ready" class="col-md-4" style="padding:0px 5px; word-wrap:break-word; font-family:Consolas,Andale Mono,Courier; font-size:small;"></div>
		</div>

		<div id="area-set" class="container" style="padding:0px; margin:10px">
			<h4>SET</h4>
			<p>Set things for later use.</p>
			<div class="col-md-8" style="padding:0px">
				<textarea id="txt-set" name="set"  style="width:100%; max-width:100%; height:140px; font-family:Consolas,Andale Mono,Courier; font-size:small;" placeholder="{ player, hp: 40, hp-max: 50, weapon: @short-sword }" onblur="goInterprete()"></textarea>
			</div>
			<div id="console-set" class="col-md-4" style="padding:0px 5px; word-wrap:break-word; font-family:Consolas,Andale Mono,Courier; font-size:small;"></div>
		</div>

		<div id="area-run" class="container" style="padding:0px; margin:10px">
			<h4>RUN</h4>
			<p>Write some rules for the game.</p>
			<div class="col-md-8" style="padding:0px">
				<textarea id="txt-run" name="run"  style="width:100%; max-width:100%; height:140px; font-family:Consolas,Andale Mono,Courier; font-size:small;" placeholder="player, hp<=0 { .dead, gamephase <~ { .gamephase: 'gameover' } }" onblur="goInterprete()"></textarea>
			</div>
			<div id="console-run" class="col-md-4" style="padding:0px 5px; word-wrap:break-word; font-family:Consolas,Andale Mono,Courier; font-size:small;"></div>
		</div>

		<!-- <div id="area-submit" class="container" style="padding:0px; margin:10px">
			<a class="btn btn-lg btn-primary btn-block" name="interprete" value="true" onclick="goInterprete()" role="button">Interprete!</a>
			<button class="btn btn-sm btn-warning btn-block" name="compile" value="true" onclick="goCompile()" type="submit">COMPILE & GO</button>
		</div> -->
	</form>
</div>

<script>
	var timerForInterpreter;
	var setTimerForInterpreter = function() {
		window.clearTimeout(timerForInterpreter);
		timerForInterpreter = window.setTimeout(goInterprete, 3000);
	};

	var goInterprete = function() {
		var txtReady = document.getElementById('txt-ready');
		var txtSet = document.getElementById('txt-set');
		var txtRun = document.getElementById('txt-run');
		var consoleReady = document.getElementById('console-ready');
		var consoleSet = document.getElementById('console-set');
		var consoleRun = document.getElementById('console-run');
		$.post('/createAjax', {
			type:	'interprete',
			ready: 	txtReady.value,
			set:	txtSet.value,
			run:	txtRun.value
		}, function(data) {
			consoleReady.innerHTML = data['cReady'];
			consoleSet.innerHTML = data['cSet'];
			consoleRun.innerHTML = data['cRun'];

			if(data['cReady'] == '' && data['cSet'] == '' && data['cRun'] == '') {
				if('localStorage' in window && window['localStorage'] !== null) {
					localStorage.setItem('ready', document.getElementById('txt-ready').value);
					localStorage.setItem('set', document.getElementById('txt-set').value);
					localStorage.setItem('run', document.getElementById('txt-run').value);
					document.getElementById('savedtime').innerHTML = 'Saved ' + new Date().toLocaleTimeString();
				}
			}
		});
	};

	var goCompile = function() {
		var txtReady = document.getElementById('txt-ready');
		var txtSet = document.getElementById('txt-set');
		var txtRun = document.getElementById('txt-run');
		var consoleReady = document.getElementById('console-ready');
		var consoleSet = document.getElementById('console-set');
		var consoleRun = document.getElementById('console-run');
		$.post('/createAjax', {
			type:	'compile',
			ready: 	txtReady.value,
			set:	txtSet.value,
			run:	txtRun.value
		}, function(data) {
			consoleReady.innerHTML = data['cReady'];
			consoleSet.innerHTML = data['cSet'];
			consoleRun.innerHTML = data['cRun'];
		});
		var editor = document.getElementById('editor');
		editor.submit();
	};

	window.onload = function() {
		// Load saved code from local storage
		if(localStorage['ready']) document.getElementById('txt-ready').value = localStorage['ready'];
		if(localStorage['set']) document.getElementById('txt-set').value = localStorage['set'];
		if(localStorage['run']) document.getElementById('txt-run').value = localStorage['run'];

		var sampleReady = document.getElementById('txt-ready');
		var sampleSet = document.getElementById('txt-set');
		var sampleRun = document.getElementById('txt-run');

		// Clear editor / saved codes
		document.getElementById('clear-editor').addEventListener('click', function() {
			sampleReady.value = '';
			sampleSet.value = '';
			sampleRun.value = '';
		});

		document.getElementById('clear-save').addEventListener('click', function() {
			localStorage['ready'] = '';
			localStorage['set'] = '';
			localStorage['run'] = '';
		});

		// Set sample codes
		document.getElementById('sample-text').addEventListener('click', function() {
			sampleReady.value = '☃ Inside <--those--> snowmen is comment line ☃\ntitle: "text demo"\nauthor: "you"\ntick: 500';
			sampleSet.value = '☃ You can just declare text, and later assign text value afterward\n  "just-text" here is a unique charm, and works like a name of the thing for later query ☃\n{ text, just-text, x:0.5, y:0.45, text-align:"center", font-size:0.2 }\n\n☃ You can also just set text from the beginning ☃\n{ text:"such text", blinky-text, x:0.5, y: 0.53, text-align:"center" }\n{ text:"much color", blinky-color-text, x:0.5, y:0.6, text-align:"center", font-color:"#ffff00", show }';
			sampleRun.value = '☃ Show text ☃\njust-text { .text:"wow", .show }\n\n☃ Blink text\n   Note that remote charming(<~) takes one tick ☃\nblinky-text, !show { blinky-text <~ { .show } }\nblinky-text, show { blinky-text <~ { .show:remove } }';
		});

		document.getElementById('sample-image').addEventListener('click', function() {
			sampleReady.value = '☃ Inside <--those--> snowmen is comment line ☃\ntitle: "image demo"\nauthor: "you"\ntick: 500';
			sampleSet.value = '☃ If a thing has a charm named "image" and file address of the image, it will show image on "show" charm.\n   You always need to set image addresses here in SET phase, so that the image can be loaded beforehand.\n   You also need to set width or height value, but not necessarily both ☃\n{ img-werewolf, image:"http://i544.photobucket.com/albums/hh327/Traumadore/werewolf.png",\n  x:0.5, y:0.5, height:0.5, show }';
			sampleRun.value = '';
		});

		document.getElementById('sample-sound').addEventListener('click', function() {
			sampleReady.value = '☃ Inside <--those--> snowmen is comment line ☃\ntitle: "image demo"\nauthor: "you"\ntick: 2000';
			sampleSet.value = '☃ If a thing has a charm named "sound" and file address of the sound, it will play sound on "trigger" charm.\n   You always need to set sound addresses here in SET phase, so that the sound can be loaded beforehand ☃\n{ eff-magic, sound:"http://www.flashkit.com/imagesvr_ce/flashkit/soundfx/Electronic/Beeps/Droid_be-TG_McL-7885/Droid_be-TG_McL-7885_hifi.mp3" }\n\n☃ Music is same as "sound", but you can pause/play the music, while you only can trigger the sound ☃\n{ bgm-demo, music:"/assets/musics/RoccoW_-_Out_of_Sight_Into_the_Mind.mp3", no-loop, play }';
			sampleRun.value = '☃ "trigger" charm is just for single use. It detaches from the thing automatically after triggering. ☃\nsound { .trigger }';
		});

		document.getElementById('sample-keyinput').addEventListener('click', function() {
			sampleReady.value = '☃ Inside <--those--> snowmen is comment line ☃\ntitle: "text demo"\nauthor: "you"\ntick: 80';
			sampleSet.value = '☃ Set texts to show key input ☃\n{ txt-keymon, x:0, y:0 }\n{ txt-keynamemon, x:0.5, y:0.52, text-align:"center", font-size:0.15 }';
			sampleRun.value = '☃ Get key input and show the ASCII number of the key.\n   "key" charm automatically attaches to every thing automatically on key event,\n   so you can just query any thing with key charm ☃\ntxt-keymon, key { .text:.key, .show }\n\n☃ Match specific keys. Default special keys are: action, cancel, up, down, left, right ☃\ntxt-keynamemon, key="action" { .text:"action", .show }\ntxt-keynamemon, key="cancel" { .text:"cancel", .show }\ntxt-keynamemon, key="up" { .text:"↑", .show }\ntxt-keynamemon, key="down" { .text:"↓", .show }\ntxt-keynamemon, key="left" { .text:"←", .show }\ntxt-keynamemon, key="right" { .text:"→", .show }\n\n☃ Hide texts after a tick ☃\ntext, show { text <~ { .show:remove } }';
		});

		document.getElementById('sample-dungeon').addEventListener('click', function() {
			sampleReady.value = '☃ Inside <--those--> snowmen is comment line ☃\ntitle: "dungeon demo"\nauthor: "you"\ntick: 80';
			sampleSet.value = '☃ Tiles ☃\n{ tile, t-dungeon-floor, passable:true, map-char:".",\n  here-a:   "/assets/tiles/sample_dungeon_floor_here_a.png",\n  here-b:   "/assets/tiles/sample_dungeon_floor_here_b.png",\n  near-a:   "/assets/tiles/sample_dungeon_floor_near_a.png",\n  near-b:   "/assets/tiles/sample_dungeon_floor_near_b.png",\n  far-a:    "/assets/tiles/sample_dungeon_floor_far_a.png",\n  far-b:    "/assets/tiles/sample_dungeon_floor_far_b.png",\n  further-a:"/assets/tiles/sample_dungeon_floor_further_a.png",\n  further-b:"/assets/tiles/sample_dungeon_floor_further_b.png"\n}\n{ tile, t-dungeon-wall, passable:false, map-char:"#",\n  here-a:   "/assets/tiles/sample_dungeon_wall_here_a.png",\n  here-b:   "/assets/tiles/sample_dungeon_wall_here_b.png",\n  near-a:   "/assets/tiles/sample_dungeon_wall_near_a.png",\n  near-b:   "/assets/tiles/sample_dungeon_wall_near_b.png",\n  far-a:    "/assets/tiles/sample_dungeon_wall_far_a.png",\n  far-b:    "/assets/tiles/sample_dungeon_wall_far_b.png",\n  further-a:"/assets/tiles/sample_dungeon_wall_further_a.png",\n  further-b:"/assets/tiles/sample_dungeon_wall_further_b.png"\n}\n\n☃ Map ☃\n{ map, demo-dungeon, cols:20, rows:10,\n  tiles:"####################\n         #...#.#...#....#.#.#\n         #.#.....#...#....#.#\n         #.#.#.#.###.####...#\n         #.###...#.#..#...#.#\n         #.....#............#\n         ##.####...###.###..#\n         ##...#..##.......###\n         #..####............#\n         ####################"\n}\n\n☃ Camera ☃\n{ camera }';
			sampleRun.value = '☃ Initialize camera ☃\ncamera, !show {\n  .at:@demo-dungeon\n  .x-pos:1\n  .y-pos:1\n  .heading:"east"\n  .show\n}\n\n☃ Bind keys to navigate dungeon ☃\ncamera, key="up" { .goforward }\ncamera, key="down" { .gobackward }\ncamera, key="left" { .turnleft }\ncamera, key="right" { .turnright }';
		});
	};
</script>